{{#partial "contenido-header"}}
  {{#if esRegistrado}}
    <span>ğŸ‘¤ {{username}}</span>
    {{#if esAdmin}}
      | <a href="/dashboard" class="link-primary">Panel Admin</a>
    {{/if}}
    <a href="/logout" class="link-danger">Cerrar sesiÃ³n</a>
  {{else}}
    <a href="/login" class="link-primary">Iniciar sesiÃ³n</a> |
    <a href="/register" class="link-primary">Registrarse</a>
  {{/if}}
{{/partial}}

{{#partial "contenido"}}
  <div class="text-center mb-4">
    <p class="lead">{{mensaje}}</p>

    <div class="d-flex flex-wrap justify-content-center gap-3 my-3">
      <a href="/hechos/buscar" class="btn btn-primary">ğŸ” Buscar Hechos</a>
      <a href="/hechos/nuevo" class="btn btn-success">ğŸ“ Cargar Nuevo Hecho</a>
    </div>

    {{#if esAdmin}}
      <div class="alert alert-warning shadow-sm mt-3">
        ğŸ›¡ï¸ <strong>Panel de Administrador:</strong> GestionÃ¡ solicitudes, estadÃ­sticas y colecciones.
        <br><a href="/dashboard" class="btn btn-warning mt-2">Ir al Panel</a>
      </div>
    {{/if}}
  </div>

  <section class="map-section my-4">
    <h2 class="text-primary mb-3 text-center">ğŸ—ºï¸ Mapa de Hechos Disponibles</h2>
    <div id="map" class="rounded shadow" style="height:65vh;"></div>
    <div class="mapa-leyenda mt-2 text-muted text-center">
      ğŸ“ Haz clic en un marcador para ver detalles del hecho.
    </div>
  </section>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const hechos = [
        {{#each hechos}}
        {
          titulo: "{{this.titulo}}",
          descripcion: "{{this.descripcion}}",
          categoria: "{{this.categoria}}",
          latitud: {{this.latitud}},
          longitud: {{this.longitud}},
          fechaAcontecimiento: "{{this.fechaAcontecimiento}}",
          id: {{this.id}}
        }{{#unless @last}},{{/unless}}
        {{/each}}
      ];

      if (hechos.length === 0) return;

      const latProm = hechos.reduce((sum, h) => sum + h.latitud, 0) / hechos.length;
      const lonProm = hechos.reduce((sum, h) => sum + h.longitud, 0) / hechos.length;

      const mapa = L.map('map').setView([latProm, lonProm], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 18
      }).addTo(mapa);

      hechos.forEach(hecho => {
        const marker = L.marker([hecho.latitud, hecho.longitud]).addTo(mapa);
        const popup = `
          <div style="max-width:200px;">
            <h6>${hecho.titulo}</h6>
            <p><strong>CategorÃ­a:</strong> ${hecho.categoria}</p>
            <p>${hecho.descripcion}</p>
            <a href="/hechos/${hecho.id}/solicitud" class="btn btn-sm btn-outline-danger">Eliminar</a>
          </div>`;
        marker.bindPopup(popup);
      });
    });
  </script>
{{/partial}}

{{>templates/layout}}
