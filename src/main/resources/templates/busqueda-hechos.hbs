{{#partial "contenido-header"}}
  <a href="/home" class="btn btn-outline-primary">â¬…ï¸ Volver al Inicio</a>
{{/partial}}

{{#partial "contenido"}}
  <div class="search-section mb-4">
    <h1 class="mb-3 text-center">ğŸ” BÃºsqueda de Hechos</h1>

    <form action="/hechos/buscar" method="GET" class="search-form">
      <div class="form-grid">
        <div class="form-group">
          <label for="titulo">TÃ­tulo</label>
          <input type="text" name="titulo" id="titulo"
                 placeholder="Buscar por tÃ­tulo..."
                 value="{{filtros.titulo}}">
        </div>

        <div class="form-group">
          <label for="categoria">CategorÃ­a</label>
          <input type="text" name="categoria" id="categoria"
                 placeholder="Ej: Incendios, Accidentes..."
                 value="{{filtros.categoria}}">
        </div>

        <div class="form-group">
          <label for="descripcion">DescripciÃ³n</label>
          <input type="text" name="descripcion" id="descripcion"
                 placeholder="Palabras clave..."
                 value="{{filtros.descripcion}}">
        </div>

        <div class="form-group">
          <label for="latitud">Latitud</label>
          <input type="number" step="0.0001" name="latitud" id="latitud"
                 placeholder="-34.6037"
                 value="{{filtros.latitud}}">
        </div>

        <div class="form-group">
          <label for="longitud">Longitud</label>
          <input type="number" step="0.0001" name="longitud" id="longitud"
                 placeholder="-58.3816"
                 value="{{filtros.longitud}}">
        </div>

        <div class="form-group">
          <label for="fechaAcontecimiento">Fecha del Hecho</label>
          <input type="date" name="fechaAcontecimiento" id="fechaAcontecimiento"
                 value="{{filtros.fechaAcontecimiento}}">
        </div>

        <div class="form-group">
          <label for="fechaCarga">Fecha de Carga</label>
          <input type="date" name="fechaCarga" id="fechaCarga"
                 value="{{filtros.fechaCarga}}">
        </div>

        <div class="form-group">
          <label for="fechaDesde">Desde</label>
          <input type="date" name="fechaDesde" id="fechaDesde"
                 value="{{filtros.fechaDesde}}">
        </div>

        <div class="form-group">
          <label for="fechaHasta">Hasta</label>
          <input type="date" name="fechaHasta" id="fechaHasta"
                 value="{{filtros.fechaHasta}}">
        </div>
      </div>

      <div class="form-actions text-center mt-3">
        <button type="submit" class="btn btn-buscar me-2">
          ğŸ” Buscar
        </button>
        <button type="button" class="btn btn-limpiar" onclick="limpiarFormulario()">
          ğŸ—‘ï¸ Limpiar
        </button>
      </div>
    </form>
  </div>

  {{#if resultadosBusqueda}}
    <div class="results-section">
      <div class="results-header d-flex justify-content-between align-items-center flex-wrap mb-3">
        <h2>Resultados: <span class="badge bg-primary">{{cantidadResultados}}</span></h2>

        <div class="view-controls">
          <button class="btn btn-sm btn-outline-primary active" data-view="lista" onclick="cambiarVista('lista')">
            ğŸ“‹ Lista
          </button>
          <button class="btn btn-sm btn-outline-primary" data-view="mapa" onclick="cambiarVista('mapa')">
            ğŸ—ºï¸ Mapa
          </button>
        </div>
      </div>

      {{#if hechos}}
        <div id="vista-lista" class="view-container active">
          <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
            {{#each hechos}}
              <div class="col">
                <div class="card shadow-sm h-100">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <h5 class="card-title">{{this.titulo}}</h5>
                      <span class="badge bg-info text-dark">{{this.categoria}}</span>
                    </div>
                    <p class="card-text">{{this.descripcion}}</p>

                    <ul class="list-unstyled small text-muted">
                      <li>ğŸ“ Lat: {{this.latitud}}, Lon: {{this.longitud}}</li>
                      <li>ğŸ“… {{this.fechaAcontecimiento}}</li>
                      {{#if this.urlMultimedia}}
                        <li>ğŸ“ <a href="{{this.urlMultimedia}}" target="_blank">Ver multimedia</a></li>
                      {{/if}}
                    </ul>
                  </div>
                  <div class="card-footer text-end">
                    <small>Cargado: {{this.fechaDeCarga}}</small><br>
                    <a href="/hechos/{{this.id}}/solicitud" class="btn btn-sm btn-danger mt-1">
                      ğŸ—‘ï¸ Solicitar EliminaciÃ³n
                    </a>
                  </div>
                </div>
              </div>
            {{/each}}
          </div>
        </div>

        <div id="vista-mapa" class="view-container mt-4">
          <div id="map" style="height: 65vh;" class="rounded shadow"></div>
          <p class="text-muted text-center mt-2">ğŸ“ Haz clic en los marcadores para ver detalles</p>
        </div>
      {{else}}
        <div class="alert alert-warning text-center">
          ğŸ˜” No se encontraron hechos con los criterios especificados.<br>
          <button class="btn btn-outline-secondary mt-2" onclick="limpiarFormulario()">
            Limpiar filtros
          </button>
        </div>
      {{/if}}
    </div>
  {{/if}}

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    function limpiarFormulario() {
      document.querySelectorAll('.search-form input').forEach(input => input.value = '');
      window.location.href = '/hechos/buscar';
    }

    function cambiarVista(vista) {
      document.querySelectorAll('.btn-view').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`[data-view="${vista}"]`).classList.add('active');
      document.querySelectorAll('.view-container').forEach(c => c.classList.remove('active'));
      document.getElementById(`vista-${vista}`).classList.add('active');
      if (vista === 'mapa') inicializarMapa();
    }

    let mapaInicializado = false;
    function inicializarMapa() {
      if (mapaInicializado) return;
      const hechos = [
        {{#each hechos}}
        {
          titulo: "{{this.titulo}}",
          descripcion: "{{this.descripcion}}",
          categoria: "{{this.categoria}}",
          latitud: {{this.latitud}},
          longitud: {{this.longitud}},
          fechaAcontecimiento: "{{this.fechaAcontecimiento}}",
          id: {{this.id}}
        }{{#unless @last}},{{/unless}}
        {{/each}}
      ];
      if (hechos.length === 0) return;

      const latProm = hechos.reduce((s, h) => s + h.latitud, 0) / hechos.length;
      const lonProm = hechos.reduce((s, h) => s + h.longitud, 0) / hechos.length;

      const mapa = L.map('map').setView([latProm, lonProm], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 18
      }).addTo(mapa);

      hechos.forEach(h => {
        L.marker([h.latitud, h.longitud])
          .addTo(mapa)
          .bindPopup(`<h6>${h.titulo}</h6>
                      <p>${h.descripcion}</p>
                      <small>ğŸ“… ${h.fechaAcontecimiento}</small><br>
                      <a href="/hechos/${h.id}/solicitud" class="btn btn-sm btn-outline-danger mt-1">Eliminar</a>`);
      });
      mapaInicializado = true;
    }
  </script>
{{/partial}}

{{> templates/layout}}
